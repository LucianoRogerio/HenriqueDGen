---
title: "Analise de Componentes Principais e Discriminantes"
author: "LucianoRogerio e HenriqueBernardino"
date: "2021-11-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---



[Wrong Page?](index.html)

## Analysis of Principal Components

This previoulsy analysis were performed aiming to select the best number of principal components.
The phenotypic data were centered using the function scale to remove the effect of trait variance at the principal components analysis.
The selection criteria for the number of principal components were variance bigger than one.

```{r Reading data}
suppressMessages(library(tidyverse))
suppressMessages(library(adegenet))
library(reactable)
library(here)

BLUPS <- readRDS(here::here("output", "BLUPsDiseaseAgro.rds"))

BLUPS[, -1] <- scale(BLUPS[ , -1], center = T, scale = T)
BLUPS[is.na(BLUPS)] <- 0
```


### Estimation of the Variance acumulated and selection of the number of Principal Components

```{r Principal Components analysis}
PCA <- prcomp(BLUPS[,-1])

Perc <- 100*PCA$sdev^2/sum(PCA$sdev^2)

PercAc <- as.vector(rep(NA, times = length(Perc)))
for(i in 1:length(Perc)) {
  PercAc[i] <- sum(Perc[1:i])
  names(PercAc)[i] <- i
}
```

#### Table 1. Variance explained by each principal component
```{r Table 1, echo = FALSE}
data.frame(PC = 1:10, Var = PCA$sdev^2) %>%
  reactable(columns = list(Var = colDef(format = colFormat(digits = 4, locales = "en-US"))))
```

#### Fig 1. Barplot of the Accumulated variances of the principal components for foliar diseases.
```{r Barplot of the PCAs, echo = FALSE}
barplot(PercAc, main = "Variance explained by PCA",
        ylab = "Cumulative variance (%)", xlab = "Number of retained PCs",
        col = c("gray", "gray", "gray", "gray", "red", "gray", "gray", "gray", "gray", "gray"))
```

This part we prepare the print location for the labels of foliar disease traits

```{r Preparing the Labels positions for PCA Graph}
PointPCA1 <- as.data.frame(PCA$x)
ArrowPCA1 <- as.data.frame(PCA$rotation)
LabelsPCA1 <- 5*ArrowPCA1
LabelsPCA1[2, 1] <- c(-1)
LabelsPCA1[3, 1] <- c(0)
LabelsPCA1[5, 1:2] <- c(1.25, -0.45)
LabelsPCA1[6, 1:2] <- c(1.9, -0.9)
LabelsPCA1[7, 1:2] <- c(2.8, -0.1)
LabelsPCA1[9, 1:2] <- c(2.7, -0.55)
LabelsPCA1[10, 1:2] <- c(1.9, -0.1)
```

#### Fig 2. Scatterplot of the Principal components 1 and 2 with the correlation arrows of the foliar disease resistance with the principal components.
```{r Figure 2, echo = FALSE}
ggplot(data = PointPCA1, aes(x = PC1, y = PC2)) +
  geom_point(na.rm = T, colour = "gray") + geom_rug(col = "steelblue", alpha = 0.2, size = 1.5) +
  geom_segment(mapping = aes(x = 0, xend = 5*PC1, y = 0, yend = 5*PC2),
               colour = "red",
               data = ArrowPCA1, arrow = arrow(type = "closed",
                                               length = unit(0.2,units = "cm"))) +
  geom_text(mapping = aes(x = PC1, y = PC2, label = rownames(ArrowPCA1)),
            data = LabelsPCA1, colour = "black") + 
  theme_bw() +
  xlab("PC1 - 31.13%") + ylab("PC2 - 23.71%")
```

#### Table 2. Analise de correlação dos Caracteristicas 
```{r Table 2, echo=FALSE}
library(tidyverse);library(here);library(reactable)

DadosManchasFoliares <- readRDS(here::here("output", "BLUPsDiseaseAgro.rds"))

DadosManchasFoliares %>% dplyr::select(-CLONE) %>% 
  cor(use = "complete.obs")  %>%
  reactable(columns = list(
    Anth = colDef(format = colFormat(digits = 3, locales = "en-US")),
    BlLS = colDef(format = colFormat(digits = 3, locales = "en-US")),
    BrLS = colDef(format = colFormat(digits = 3, locales = "en-US")),
    WhLS = colDef(format = colFormat(digits = 3, locales = "en-US")),
    Vigor = colDef(format = colFormat(digits = 3, locales = "en-US")),
    NR = colDef(format = colFormat(digits = 3, locales = "en-US")),
    DRY = colDef(format = colFormat(digits = 3, locales = "en-US")),
    DMC = colDef(format = colFormat(digits = 3, locales = "en-US")),
    PTR = colDef(format = colFormat(digits = 3, locales = "en-US")),
    PPA = colDef(format = colFormat(digits = 3, locales = "en-US"))))
```

## Discriminant Analysis of Principal Components

```{r Discriminant Analysis of Principal Components}
library(adegenet); library(ggplot2)

BLUPS <- readRDS(here::here("output", "BLUPsDiseaseAgro.rds"))
BLUPS[, -1] <- scale(BLUPS[, -1], center = T, scale = T)
BLUPS[is.na(BLUPS)] <- 0
rownames(BLUPS) <- BLUPS$CLONE
BLUPS$CLONE <- NULL

set.seed(1)
DAPCHen <- find.clusters(BLUPS, n.pca = 5, max.n.clust = 20, choose.n.clust = FALSE, criterion = "diffNgroup")
ClassDAPCHen <- DAPCHen$grp

DAPCHenGraph <- dapc(BLUPS, grp = ClassDAPCHen, n.pca = 5, n.da = 2)
saveRDS(DAPCHenGraph, here::here("output", "DAPCAn.rds"))

VarDAPC <- 10*sum(DAPCHenGraph$pca.eig[1:5])*DAPCHenGraph$var*DAPCHenGraph$eig/sum(DAPCHenGraph$eig)

DAPCIndPoint <- data.frame(DAPCHenGraph$ind.coord, grp = DAPCHenGraph$grp)
DAPCGrpEllip <- data.frame(DAPCHenGraph$grp.coord, grp = as.character(1:3))
ArrowDAPC <- as.data.frame(DAPCHenGraph$var.contr)
LabelsDAPC <- data.frame(ArrowDAPC*7)
LabelsDAPC[1, 2] <- c(1.45)
LabelsDAPC[2, 1:2] <- c(0.1, 1.69)
LabelsDAPC[3, 1:2] <- c(0.7, 1.69)
LabelsDAPC[5, 2] <- c(0)
LabelsDAPC[6, 2] <- c(0.4)
LabelsDAPC[9, 2] <- c(0.35)
LabelsDAPC[10, 2] <- c(0.05)
```

#### Fig 3. Scatterplot of the first and second linear discriminant function of the discriminant analysis of principal components for cassava foliar diseases, with four clusters
```{r Figure 3, echo = F}
ggplot(data = DAPCIndPoint, aes(x = LD1, y = LD2, color = grp)) +
  geom_point(na.rm = T) + geom_rug(col = "steelblue", alpha = 0.2, size = 1.5) +
  theme_bw() +
  scale_color_viridis_d() +
  stat_ellipse(geom="polygon", aes(fill = grp), 
               alpha = 0.2, 
               show.legend = FALSE, 
               level = 0.95) + guides(color = "none") + 
  geom_label(data = DAPCGrpEllip, mapping = aes(x = LD1, y = LD2, label = grp)) +
  geom_segment(mapping = aes(x = 0, xend = 7*LD1, y = 0, yend = 7*LD2),
               colour = "red",
               data = ArrowDAPC, arrow = arrow(type = "closed",
                                               length = unit(0.2,units = "cm"))) +
    geom_text(mapping = aes(x = LD1, y = LD2, label = rownames(LabelsDAPC)),
            data = LabelsDAPC, colour = "black") +
  xlab(paste0("LD1 - ", round(VarDAPC[[1]], digits = 2), "%")) +
  ylab(paste0("LD2 - ", round(VarDAPC[[2]], digits = 2), "%"))
```

```{r Preparing data for Boxplot}
suppressMessages(library(reshape2))
BLUPS <- readRDS(here::here("output", "BLUPsDiseaseAgro.rds"))
BLUPS$CLONE <- rownames(BLUPS)
BLUPS$Grp <- DAPCHenGraph$grp

BLUPSBoxplot <- reshape2::melt(BLUPS, variable.name = "Trait", value.name = "Y", id.vars = c("CLONE", "Grp"))
```

#### Fig 4. Boxplots of the BLUPS of the accessions grouped by the discriminant analysis of principal components for cassava foliar diseases traits
```{r Figure 4, echo = FALSE, warning = FALSE}
library(multcompView)
ggplot(data = BLUPSBoxplot, mapping = aes(x = Grp, y = Y, fill = Grp)) +
  geom_boxplot(outlier.shape = NA) + facet_wrap(facets = ~ Trait, ncol = 2, scales = "free_y") +
  scale_fill_viridis_d() + guides(fill = "none") + ylab("Adjusted Means") + xlab("DACP Group")
Test <- aov(lm(data = BLUPSBoxplot2, formula = Y ~ Grp))
TUKEY <- TukeyHSD(Test, which = "Grp")


generate_label_df <- function(TUKEY, variable){
 
     # Extract labels and factor levels from Tukey post-hoc 
     Tukey.levels <- TUKEY[[variable]][,4]
     Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
     
     #I need to put the labels in the same order as in the boxplot :
     Tukey.labels$treatment=rownames(Tukey.labels)
     Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
     return(Tukey.labels)
     }
generate_label_df(TUKEY, "Grp")


library(multcompView)
 
# Create data
set.seed(1)
treatment <- rep(c("A", "B", "C", "D", "E"), each=20) 
value=c( sample(2:5, 20 , replace=T) , sample(6:10, 20 , replace=T), sample(1:7, 20 , replace=T), sample(3:10, 20 , replace=T) , sample(10:20, 20 , replace=T) )
data=data.frame(treatment,value)
 
# What is the effect of the treatment on the value ?
model=lm( data$value ~ data$treatment )
ANOVA=aov(model)
 
# Tukey test to study each pair of treatment :
TUKEY <- TukeyHSD(x=ANOVA, 'data$treatment', conf.level=0.95)
 
# Tuckey test representation :
plot(TUKEY , las=1 , col="brown")


generate_label_df <- function(TUKEY, variable){
 
     # Extract labels and factor levels from Tukey post-hoc 
     Tukey.levels <- TUKEY[[variable]][,4]
     Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
     
     #I need to put the labels in the same order as in the boxplot :
     Tukey.labels$treatment=rownames(Tukey.labels)
     Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
     return(Tukey.labels)
     }
 
# Apply the function on my dataset
LABELS <- generate_label_df(TUKEY , "data$treatment")
 
 
# A panel of colors to draw each group with the same color :
my_colors <- c( 
  rgb(143,199,74,maxColorValue = 255),
  rgb(242,104,34,maxColorValue = 255), 
  rgb(111,145,202,maxColorValue = 255)
  )
 
# Draw the basic boxplot
a <- boxplot(data$value ~ data$treatment , ylim=c(min(data$value) , 1.1*max(data$value)) , col=my_colors[as.numeric(LABELS[,1])] , ylab="value" , main="")
 
# I want to write the letter over each box. Over is how high I want to write it.
over <- 0.1*max( a$stats[nrow(a$stats),] )
 
#Add the labels
text( c(1:nlevels(data$treatment)) , a$stats[nrow(a$stats),]+over , LABELS[,1]  , col=my_colors[as.numeric(LABELS[,1])] )
```

[Next page](Den_IndSH.html)

[Last page](AnalisesModelosMistos.html)

[Back to home](index.html)
