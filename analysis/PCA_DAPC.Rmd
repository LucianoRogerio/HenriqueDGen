---
title: "Analise de Componentes Principais e Discriminantes"
author: "LucianoRogerio e HenriqueBernardino"
date: "2021-11-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---



[Wrong Page?](index.html)

## Analysis of Principal Components

This previoulsy analysis were performed aiming to select the best number of principal components.
The phenotypic data were centered using the function scale to remove the effect of trait variance at the principal components analysis.
The selection criteria for the number of principal components were variance bigger than one.

```{r Reading data}
suppressMessages(library(tidyverse))
suppressMessages(library(adegenet))
library(reactable)
library(here)

BLUPS <- readRDS(here::here("output", "BLUPsDiseaseAgro.rds"))

BLUPS[, -1] <- scale(BLUPS[ , -1], center = T, scale = T)
BLUPS[is.na(BLUPS)] <- 0
```


### Estimation of the Variance acumulated and selection of the number of Principal Components

```{r Principal Components analysis}
PCA <- prcomp(BLUPS[,-1])

Perc <- 100*PCA$sdev^2/sum(PCA$sdev^2)

PercAc <- as.vector(rep(NA, times = length(Perc)))
for(i in 1:length(Perc)) {
  PercAc[i] <- sum(Perc[1:i])
  names(PercAc)[i] <- i
}
write.table(PCA$rotation, file = here::here("output", "CorrelacoesPCAseTraits.csv"), sep = ",", quote = F)
```

#### Table 1. Variance explained by each principal component
```{r Table 1, echo = FALSE}
data.frame(PC = 1:11, Var = PCA$sdev^2) %>%
  reactable(columns = list(Var = colDef(format = colFormat(digits = 4, locales = "en-US"))))
```

#### Fig 1. Barplot of the Accumulated variances of the principal components for foliar diseases.
```{r Barplot of the PCAs, echo = FALSE}
tiff(filename = here::here("output", "Fig6_BarplotAccumulatedVariancesPCFoliarDiseases.tiff"), res = 350,
     compression = "lzw", units = "cm", width = 20, height = 15)
barplot(PercAc, main = "Variance explained by PCA",
        ylab = "Cumulative variance (%)", xlab = "Number of retained PCs",
        col = c(rep("gray", 2), "red", rep("gray", 8)))
dev.off()
```

This part we prepare the print location for the labels of foliar disease traits

```{r Preparing the Labels positions for PCA Graph}
PointPCA1 <- as.data.frame(PCA$x)
ArrowPCA1 <- as.data.frame(PCA$rotation)
LabelsPCA1 <- 6*ArrowPCA1
LabelsPCA1[1, 1:2] <- c(-0.6, -1.8)
LabelsPCA1[2, 2] <- c(-1.8)
LabelsPCA1[3, 2] <- c(-2.5)
LabelsPCA1[4, 1] <- c(-0.8)
LabelsPCA1[5, 1:2] <- c(1.9, -0.6)
LabelsPCA1[6, 1] <- c(1.3)
LabelsPCA1[7, 2] <- c(-0.4)
LabelsPCA1[9, 2] <- c(0)
LabelsPCA1[10, 1:2] <- c(2, -1.7)
LabelsPCA1[11, 1:2] <- c(2.3, -1)
```

#### Fig 2. Scatterplot of the Principal components 1 and 2 with the correlation arrows of the foliar disease resistance with the principal components.
```{r Figure 2, echo = FALSE}
#tiff(filename = here::here("output", "Fig7_ScatterplotPC1and2CorrelationArrowsFoliarDiseaseResistancePC.tiff"),
#     res = 350, units = "cm", compression = "lzw", width = 20, height = 15)
ggplot(data = PointPCA1, aes(x = PC1, y = PC2)) +
  geom_point(na.rm = T, colour = "gray") + geom_rug(col = "steelblue", alpha = 0.2, linewidth = 1.5) +
  geom_segment(mapping = aes(x = 0, xend = 5*PC1, y = 0, yend = 5*PC2),
               colour = "red",
               data = ArrowPCA1, arrow = arrow(type = "closed",
                                               length = unit(0.2,units = "cm"))) +
  geom_text(mapping = aes(x = PC1, y = PC2, label = rownames(ArrowPCA1)),
            data = LabelsPCA1, colour = "black") + 
  theme_minimal() +
  xlab("PC1 - 28.13%") + ylab("PC2 - 27.08%")
#dev.off()
```

#### Table 2. Analise de correlação dos Caracteristicas 
```{r Table 2, echo=FALSE}
library(tidyverse);library(here);library(reactable)

DadosManchasFoliares <- readRDS(here::here("output", "BLUPsDiseaseAgro.rds"))

DadosManchasFoliares %>% dplyr::select(-CLONE) %>% 
  cor(use = "complete.obs")  %>%
  reactable(columns = list(
    Anth = colDef(format = colFormat(digits = 3, locales = "en-US")),
    BlLS = colDef(format = colFormat(digits = 3, locales = "en-US")),
    BrLS = colDef(format = colFormat(digits = 3, locales = "en-US")),
    WhLS = colDef(format = colFormat(digits = 3, locales = "en-US")),
    Vigor = colDef(format = colFormat(digits = 3, locales = "en-US")),
    NR = colDef(format = colFormat(digits = 3, locales = "en-US")),
    DRY = colDef(format = colFormat(digits = 3, locales = "en-US")),
    DMC = colDef(format = colFormat(digits = 3, locales = "en-US")),
    PTR = colDef(format = colFormat(digits = 3, locales = "en-US")),
    PPA = colDef(format = colFormat(digits = 3, locales = "en-US"))))

write.table(DadosManchasFoliares %>% dplyr::select(-CLONE) %>% 
  cor(use = "complete.obs"), file = here::here("output", "CorrelacoesTraits.csv"), sep = ",", quote = F)
```

## Correlogram

```{r Correlogram}
library(corrplot)
#tiff(filename = here::here("output", "Correlogram.tiff"), height = 10, width = 10, compression = "lzw",
#     units = "cm", res = 350)
DadosManchasFoliares %>% dplyr::select(-CLONE) %>% cor(use = "complete.obs") %>%
  corrplot::corrplot(tl.col = "black",order = "hclust") %>%
  corrRect(name = c("Anth", "DMC", "RF", "NR", "PPA"))
#dev.off()
```



## Discriminant Analysis of Principal Components

```{r Discriminant Analysis of Principal Components}
library(adegenet); library(ggplot2)

BLUPS <- readRDS(here::here("output", "BLUPsDiseaseAgro.rds"))
BLUPS[, -1] <- scale(BLUPS[, -1], center = T, scale = T)
BLUPS[is.na(BLUPS)] <- 0
rownames(BLUPS) <- BLUPS$CLONE
BLUPS$CLONE <- NULL

set.seed(1)
DAPCHen <- find.clusters(BLUPS, n.pca = 3, max.n.clust = 20, choose.n.clust = F, criterion = "diffNgroup")
ClassDAPCHen <- DAPCHen$grp

DAPCHenGraph <- dapc(BLUPS, grp = ClassDAPCHen, n.pca = 3, n.da = 2)
saveRDS(DAPCHenGraph, here::here("output", "DAPCAn.rds"))

DAPCHenGraph <- readRDS(file = here::here("output", "DAPCAn.rds"))
VarDAPC <- 10*sum(DAPCHenGraph$pca.eig[1:3])*DAPCHenGraph$var*DAPCHenGraph$eig/sum(DAPCHenGraph$eig)

DAPCIndPoint <- data.frame(DAPCHenGraph$ind.coord, grp = DAPCHenGraph$grp)
DAPCGrpEllip <- data.frame(DAPCHenGraph$grp.coord, grp = as.character(1:3))
ArrowDAPC <- as.data.frame(DAPCHenGraph$var.contr)
LabelsDAPC <- data.frame(ArrowDAPC*7)
LabelsDAPC[1, 2] <- c(1.1)
LabelsDAPC[2, 1] <- c(0.4)
LabelsDAPC[3, 1] <- c(-0.2)
LabelsDAPC[5, 2] <- c(0.3)
LabelsDAPC[6, 2] <- c(-0.2)
LabelsDAPC[7, 1] <- c(-0.3)
LabelsDAPC[8, 2] <- c(0.7)
LabelsDAPC[9, 2] <- c(-0.35)
LabelsDAPC[10, 1] <- c(1.95)
LabelsDAPC[11, 2] <- c(-0.3)
```

#### Fig 3. Scatterplot of the first and second linear discriminant function of the discriminant analysis of principal components for cassava foliar diseases, with three clusters
```{r Figure 3, echo = F}
#tiff(filename = here::here("output", "Fig8_ScatterplotLD1and2CassavaFoliarDiseases3clusters.tiff"),
#     res = 350, units = "cm", compression = "lzw", width = 20, height = 15)
ggplot(data = DAPCIndPoint, aes(x = LD1, y = LD2, color = grp)) +
  geom_rug(col = "steelblue", alpha = 0.2, size = 1.5) +
  theme_minimal() +
  stat_ellipse(geom="polygon", aes(fill = grp), 
               alpha = 0.6, 
               show.legend = FALSE, 
               level = 0.95) + guides(color = "none") + 
  geom_point(na.rm = T) + 
  geom_label(data = DAPCGrpEllip, mapping = aes(x = LD1, y = LD2, label = grp)) +
  geom_segment(mapping = aes(x = 0, xend = 7*LD1, y = 0, yend = 7*LD2),
               colour = "red",
               data = ArrowDAPC, arrow = arrow(type = "closed",
                                               length = unit(0.2,units = "cm"))) +
    geom_text(mapping = aes(x = LD1, y = LD2, label = rownames(LabelsDAPC)),
            data = LabelsDAPC, colour = "red2") +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  xlab(paste0("LD1 - ", round(VarDAPC[[1]], digits = 2), "%")) +
  ylab(paste0("LD2 - ", round(VarDAPC[[2]], digits = 2), "%"))
#dev.off()
```

```{r Preparing data for Boxplot}
suppressMessages(library(reshape2))
BLUPS <- readRDS(here::here("output", "BLUPsDiseaseAgro.rds"))
DAPCHenGraph<- readRDS(here::here("output", "DAPCAn.rds"))
BLUPS$CLONE <- rownames(BLUPS)
BLUPS$Grp <- DAPCHenGraph$grp

BLUPSBoxplot <- reshape2::melt(BLUPS, variable.name = "Trait", value.name = "Y", id.vars = c("CLONE", "Grp"))
```

#### Fig 4. Boxplots of the BLUPS of the accessions grouped by the discriminant analysis of principal components for cassava foliar diseases traits
```{r Figure 4, echo = FALSE, warning = FALSE}
library(multcompView); library(data.table)
library(tidyverse)
Traits <- unique(BLUPSBoxplot$Trait) %>% as.character
variable <- "Grp"
generate_label_df <- function(ANOVA, TUKEY, variable){
 
     # Extract labels and factor levels from Tukey post-hoc 
     
     Tukey.labels <-  (multcompLetters4(ANOVA, TUKEY)[[variable]]$Letters) %>% 
       .[order(names(.))]
     return(Tukey.labels)
     }

for(i in Traits) {
  BLUPSBX <- BLUPSBoxplot %>% filter(Trait == i)
  ObjName <- paste0("bx", i)
  
  model <- lm(formula = Y ~ Grp, data = BLUPSBX)
  ANOVA <- aov(model)
  TUKEY <- TukeyHSD(x=ANOVA, 'Grp', conf.level=0.95)
  
  LABELS <- generate_label_df(ANOVA, TUKEY, "Grp")
  
  over <- BLUPSBX %>% dplyr::group_by(Grp) %>%
    dplyr::summarise(Max = quantile(Y, probs = 0.75, na.rm = T)) %>% 
    cbind(LABELS)
  
  BXplot <- BLUPSBX %>% ggplot(aes(x = Grp, y = Y, fill = Grp)) +
    geom_boxplot(outlier.shape = NA) +
    geom_text(aes(x = Grp, y = Max, label = LABELS), data = over, hjust = 1.5, vjust = -0.2) +
     theme_minimal() + theme(legend.position = "none") + labs(x = NULL, y = i)
  
  assign(paste0("bx", i), BXplot)
}

library(ggpubr)
#tiff(filename = here::here("output", "Fig9_BoxplotsBLUPSDAGrpCassavaFoliarDiseases.tiff"), res = 350,
#     compression = "lzw", units = "cm", width = 20, height = 25)
ggarrange(bxAnth, bxBlLS, bxBrLS,
          bxWhLS, bxVigor, bxRF,
          bxNR, bxDMC, bxDRY,
          bxPPA, bxPTR,
          ncol = 3, nrow = 4)
#dev.off()
```

[Next page](Den_IndSH.html)

[Last page](AnalisesModelosMistos.html)

[Back to home](index.html)
